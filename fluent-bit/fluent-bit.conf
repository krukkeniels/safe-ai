# safe-ai audit log pipeline
# Tails Squid JSON access log and ships to Loki.

[SERVICE]
    Flush            1
    Log_Level        info
    Parsers_File     parsers.conf
    HTTP_Server      On
    HTTP_Listen      0.0.0.0
    HTTP_Port        2020
    storage.path     /fluent-bit/db/
    storage.total_limit_size 256M

[INPUT]
    Name             tail
    Path             /var/log/squid/access.log
    Tag              safe-ai.proxy
    Parser           squid_json
    Refresh_Interval 5
    DB               /fluent-bit/db/tail-position.db

[FILTER]
    Name             modify
    Match            *
    Add              hostname ${SAFE_AI_HOSTNAME}

[OUTPUT]
    Name             loki
    Match            *
    Host             ${SAFE_AI_LOKI_HOST}
    Port             ${SAFE_AI_LOKI_PORT}
    Tls              ${SAFE_AI_LOKI_TLS}
    Http_User        ${SAFE_AI_LOKI_USER}
    Http_Passwd      ${SAFE_AI_LOKI_PASS}
    Labels           job=safe-ai,hostname=${SAFE_AI_HOSTNAME}
    Retry_Limit      5
