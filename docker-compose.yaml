# safe-ai: Sandboxed AI coding agent environment
#
# Two containers: sandbox (dev env, no internet) + proxy (Squid allowlist).
# The sandbox is on an internal-only Docker network â€” it cannot reach the
# internet. All outbound traffic goes through the proxy, which enforces
# the domain allowlist.
#
# Usage:
#   docker compose up -d
#   ssh -p 2222 dev@localhost
#
# Override allowlist:
#   SAFE_AI_ALLOWLIST=./my-allowlist.yaml docker compose up -d

services:
  sandbox:
    image: safe-ai-sandbox:latest
    build:
      context: ./sandbox
      dockerfile: Dockerfile
    container_name: safe-ai-sandbox
    hostname: sandbox
    networks:
      - internal
    dns:
      - 172.28.0.2
    ports:
      - "${SAFE_AI_SSH_PORT:-2222}:22"
    volumes:
      - workspace:/workspace
      - ${SAFE_AI_SSH_KEY:-~/.ssh/id_ed25519.pub}:/home/dev/.ssh/authorized_keys:ro
    environment:
      - http_proxy=http://proxy:3128
      - https_proxy=http://proxy:3128
      - HTTP_PROXY=http://proxy:3128
      - HTTPS_PROXY=http://proxy:3128
      - no_proxy=localhost,127.0.0.1
      - NO_PROXY=localhost,127.0.0.1
    security_opt:
      - seccomp=seccomp.json
      - no-new-privileges:true
    cap_drop:
      - ALL
    read_only: true
    tmpfs:
      - /tmp:rw,noexec,nosuid,size=2g
      - /run:rw,noexec,nosuid,size=64m
    deploy:
      resources:
        limits:
          memory: 8g
          cpus: "4"
          pids: 512
    healthcheck:
      test: ["CMD-SHELL", "pgrep sshd > /dev/null || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
    restart: unless-stopped
    depends_on:
      proxy:
        condition: service_healthy

  proxy:
    image: safe-ai-proxy:latest
    build:
      context: ./proxy
      dockerfile: Dockerfile
    container_name: safe-ai-proxy
    hostname: proxy
    networks:
      internal:
        ipv4_address: 172.28.0.2
      external:
    volumes:
      - ${SAFE_AI_ALLOWLIST:-./allowlist.yaml}:/etc/safe-ai/allowlist.yaml:ro
    environment:
      - SAFE_AI_DEFAULT_DOMAINS=${SAFE_AI_DEFAULT_DOMAINS:-}
    healthcheck:
      test: ["CMD-SHELL", "squid -k check && pgrep dnsmasq > /dev/null"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 5s
    deploy:
      resources:
        limits:
          memory: 256m
          cpus: "1"
          pids: 64
    restart: unless-stopped

networks:
  internal:
    driver: bridge
    internal: true
    ipam:
      config:
        - subnet: 172.28.0.0/16
  external:
    driver: bridge

volumes:
  workspace:
    driver: local
