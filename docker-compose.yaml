# safe-ai: Sandboxed AI coding agent environment
#
# Two containers: sandbox (dev env, no internet) + proxy (Squid allowlist).
# The sandbox is on an internal-only Docker network â€” it cannot reach the
# internet. All outbound traffic goes through the proxy, which enforces
# the domain allowlist.
#
# Usage:
#   docker compose up -d
#   ssh -p 2222 dev@localhost
#
# Override allowlist:
#   SAFE_AI_ALLOWLIST=./my-allowlist.yaml docker compose up -d

services:
  sandbox:
    image: safe-ai-sandbox:latest
    build:
      context: ./sandbox
      dockerfile: Dockerfile
    container_name: safe-ai-sandbox
    hostname: sandbox
    runtime: ${SAFE_AI_RUNTIME:-runc}
    networks:
      - internal
    dns:
      - 172.28.0.2
    volumes:
      - workspace:/workspace
      - ${SAFE_AI_SSH_KEY:-~/.ssh/id_ed25519.pub}:/home/dev/.ssh/authorized_keys:ro
    environment:
      - http_proxy=http://proxy:3128
      - https_proxy=http://proxy:3128
      - HTTP_PROXY=http://proxy:3128
      - HTTPS_PROXY=http://proxy:3128
      - no_proxy=localhost,127.0.0.1
      - NO_PROXY=localhost,127.0.0.1
    security_opt:
      - seccomp=seccomp.json
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - SETUID        # sshd: switch to login user
      - SETGID        # sshd: switch group
      - SYS_CHROOT    # sshd: privilege separation
      - NET_BIND_SERVICE  # sshd: bind port 22
      - CHOWN         # sshd: manage runtime files
    read_only: true
    tmpfs:
      - /tmp:rw,noexec,nosuid,size=2g
      - /run:rw,noexec,nosuid,size=64m
    deploy:
      resources:
        limits:
          memory: ${SAFE_AI_SANDBOX_MEMORY:-8g}
          cpus: "${SAFE_AI_SANDBOX_CPUS:-4}"
          pids: 512
    healthcheck:
      test: ["CMD-SHELL", "pgrep sshd > /dev/null || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
    restart: unless-stopped
    depends_on:
      proxy:
        condition: service_healthy

  proxy:
    image: safe-ai-proxy:latest
    build:
      context: ./proxy
      dockerfile: Dockerfile
    container_name: safe-ai-proxy
    hostname: proxy
    networks:
      internal:
        ipv4_address: 172.28.0.2
      external:
    volumes:
      - ${SAFE_AI_ALLOWLIST:-./allowlist.yaml}:/etc/safe-ai/allowlist.yaml:ro
      - squid-logs:/var/log/squid
    ports:
      - "${SAFE_AI_SSH_PORT:-2222}:2222"
    environment:
      - SAFE_AI_DEFAULT_DOMAINS=${SAFE_AI_DEFAULT_DOMAINS:-}
      - SAFE_AI_SSH_FORWARD=1
      - SAFE_AI_GATEWAY_DOMAIN=${SAFE_AI_GATEWAY_DOMAIN:-}
      - SAFE_AI_GATEWAY_TOKEN=${SAFE_AI_GATEWAY_TOKEN:-}
    healthcheck:
      test: ["CMD-SHELL", "squid -k check && pgrep dnsmasq > /dev/null && pgrep socat > /dev/null"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 5s
    deploy:
      resources:
        limits:
          memory: 256m
          cpus: "1"
          pids: 128
    restart: unless-stopped

  # ---- Audit Logging (optional) ----
  # Enable with: docker compose --profile logging up -d
  # By default ships to local Loki. Set SAFE_AI_LOKI_URL to ship externally.

  fluent-bit:
    image: fluent/fluent-bit:3.2
    container_name: safe-ai-fluent-bit
    profiles: ["logging"]
    entrypoint: /safe-ai/entrypoint.sh
    environment:
      - SAFE_AI_LOKI_URL=${SAFE_AI_LOKI_URL:-}
      - SAFE_AI_HOSTNAME=${SAFE_AI_HOSTNAME:-safe-ai}
    volumes:
      - squid-logs:/var/log/squid:ro
      - ./fluent-bit/fluent-bit.conf:/fluent-bit/etc/fluent-bit.conf:ro
      - ./fluent-bit/parsers.conf:/fluent-bit/etc/parsers.conf:ro
      - ./fluent-bit/entrypoint.sh:/safe-ai/entrypoint.sh:ro
      - fluent-bit-db:/fluent-bit/db
    networks:
      - internal
      - external
    healthcheck:
      test: ["CMD-SHELL", "wget -q --spider http://localhost:2020/api/v1/health"]
      interval: 30s
      timeout: 5s
      retries: 3
    deploy:
      resources:
        limits:
          memory: 64m
          cpus: "0.25"
    restart: unless-stopped

  loki:
    image: grafana/loki:3.3
    container_name: safe-ai-loki
    profiles: ["logging"]
    command: -config.file=/etc/loki/local-config.yaml
    volumes:
      - loki-data:/loki
      - ./loki/loki-config.yaml:/etc/loki/local-config.yaml:ro
    networks:
      - internal
    healthcheck:
      test: ["CMD-SHELL", "wget -q --spider http://localhost:3100/ready"]
      interval: 30s
      timeout: 5s
      retries: 3
    deploy:
      resources:
        limits:
          memory: 512m
          cpus: "1"
    restart: unless-stopped

  grafana:
    image: grafana/grafana:11.4
    container_name: safe-ai-grafana
    profiles: ["logging"]
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=${SAFE_AI_GRAFANA_PASSWORD:-admin}
      - GF_AUTH_ANONYMOUS_ENABLED=true
      - GF_AUTH_ANONYMOUS_ORG_ROLE=Viewer
    volumes:
      - grafana-data:/var/lib/grafana
      - ./grafana/provisioning:/etc/grafana/provisioning:ro
      - ./grafana/dashboards:/var/lib/grafana/dashboards:ro
    ports:
      - "${SAFE_AI_GRAFANA_PORT:-3000}:3000"
    networks:
      - internal
    depends_on:
      loki:
        condition: service_healthy
    deploy:
      resources:
        limits:
          memory: 256m
          cpus: "0.5"
    restart: unless-stopped

networks:
  internal:
    driver: bridge
    internal: true
    ipam:
      config:
        - subnet: 172.28.0.0/16
  external:
    driver: bridge

volumes:
  workspace:
    driver: local
  squid-logs:
    driver: local
  fluent-bit-db:
    driver: local
  loki-data:
    driver: local
  grafana-data:
    driver: local
